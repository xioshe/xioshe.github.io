---
title: è·¯ç”±ç®—æ³•â€”â€”é›†åˆç‚¹å“ˆå¸Œ
date: 2024-08-13 00:37:00
tags:
- ç®—æ³•
- é›†åˆç‚¹å“ˆå¸Œ
categories:
- æŠ€æœ¯å®è·µ
---

è·¯ç”±ç®—æ³•æ˜¯ä¸ºäº†è§£å†³å°† n ä¸ªè‹¹æœ ğŸ å‡åˆ†åˆ° k ä¸ªç¯®å­ ğŸ§º ä¸­çš„é—®é¢˜ï¼Œéš¾ç‚¹åœ¨äºéšæ—¶éƒ½å¯èƒ½å¢åŠ ç¯®å­æˆ–è€…å‡å°‘ç¯®å­ã€‚è·¯ç”±ç®—æ³•æœ‰ä¸¤ä¸ªè¦æ±‚ï¼Œä¸€æ˜¯æ¯ä¸ªç¯®å­é‡Œçš„è‹¹æœæ•°é‡å·®ä¸å¤šï¼ŒäºŒæ˜¯å¢å‡ç¯®å­æ—¶éœ€è¦ç§»åŠ¨çš„è‹¹æœæ•°é‡å°½å¯èƒ½å°‘ï¼Œå‰è€…ç§°ä¸º**åˆ†å¸ƒå‡è¡¡**ï¼Œåè€…ç§°ä¸º**å¯æ‰©å±•**ã€‚

å­˜å‚¨é¢†åŸŸï¼Œè·¯ç”±ç®—æ³•çš„è‹¹æœæŒ‡çš„æ˜¯éœ€è¦å­˜å‚¨çš„æ•°æ®ï¼Œç¯®å­æŒ‡çš„æ˜¯æä¾›å­˜å‚¨åŠŸèƒ½çš„èŠ‚ç‚¹ã€‚å­˜å‚¨é¢†åŸŸæµä¼ è¾ƒå¹¿çš„è·¯ç”±ç®—æ³•æ˜¯[ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•](https://blog.prochase.top/2024/08/consitent-hashing/)ï¼Œä½†è¿˜æœ‰å¦ä¸€ç§åŒæ ·åŸºäºå“ˆå¸Œå‡½æ•°çš„ç®—æ³•ï¼Œä¹Ÿå…¼å…·**åˆ†å¸ƒå‡è¡¡**å’Œ**å¯æ‰©å±•**çš„ç‰¹ç‚¹ï¼Œå³æœ¬æ–‡çš„ä¸»è§’â€”â€”é›†åˆç‚¹å“ˆå¸Œï¼ˆRendezvous hashingï¼‰ã€‚

## é›†åˆç‚¹å“ˆå¸Œçš„åŸç†

é›†åˆç‚¹å“ˆå¸Œç®—æ³•çš„æ ¸å¿ƒæ€æƒ³æ˜¯å¯¹äºæ¯ä¸ªè‹¹æœï¼Œåˆ†é…ä¸€ä¸ªéšæœºçš„ç¯®å­åºåˆ—ï¼Œé€‰æ‹©åºåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªç¯®å­ä½œä¸ºå®¹å™¨ã€‚

![img](https://img.prochase.top/bkimg/2024/08/4afcc910883b4808cd15abb9fad63487.png)

å½“åºåˆ—ä¸­ç¬¬ä¸€ä¸ªç¯®å­å˜å¾—ä¸å¯ç”¨æ—¶ï¼Œé€‰æ‹©ç¬¬äºŒä¸ªç¯®å­ã€‚è¿™æ ·å°±ä¿è¯äº†å‡å°‘èŠ‚ç‚¹æ—¶ï¼Œåªéœ€è¦ç§»åŠ¨è¢«ç§»é™¤èŠ‚ç‚¹ä¸Šçš„é”®ï¼Œå…¶ä»–èŠ‚ç‚¹ä¸Šçš„é”®ä¸å—å½±å“ã€‚ä»ä¸Šå›¾ç§»é™¤ S2 èŠ‚ç‚¹æ—¶ï¼Œåªæœ‰åŸæœ¬ç¬¬ä¸€é€‰æ‹©æ˜¯ S2 çš„é”®éœ€è¦è¿ç§»ã€‚å› ä¸ºåºåˆ—çš„ç¬¬äºŒä¸ªç¯®å­æ˜¯éšæœºçš„ï¼ŒåŸæœ¬ S2 ä¸Šçš„é”®ä¼šè¢«å¹³å‡åˆ†é…ç»™å‰©ä¸‹çš„èŠ‚ç‚¹ï¼Œä¸ä¼šå¯¼è‡´æŸä¸€ä¸ªèŠ‚ç‚¹çš„æ•°æ®é‡æ¿€å¢çš„**æ•°æ®å€¾æ–œ**é—®é¢˜ã€‚

![img](https://img.prochase.top/bkimg/2024/08/d2c9deb1d1c4f1a2947b2f6696b9a47c.png)

å®é™…å®ç°ä¸­ï¼Œä¸éœ€è¦çœŸæ­£åœ°è®°å½•æ¯ä¸€ä¸ªè‹¹æœçš„ç¯®å­åºåˆ—ï¼Œåªéœ€è¦ä¿è¯ç¯®å­ä¸å˜æ—¶ï¼Œæ¯ä¸ªè‹¹æœå¯¹åº”çš„ç¯®å­åºåˆ—ä¹Ÿä¸ä¼šå˜å³å¯ã€‚è¦å®ç°è¿™ç§åŠŸèƒ½ï¼Œä¸€ä¸ªè¡Œä¹‹æœ‰æ•ˆçš„åŠæ³•æ˜¯åˆ©ç”¨å“ˆå¸Œå‡½æ•°çš„ç¡®å®šæ€§ï¼Œç›¸åŒçš„é”®èƒ½å¾—åˆ°ç›¸åŒçš„å“ˆå¸Œå€¼ã€‚åœ¨ä¸ºè‹¹æœæŒ‘é€‰ç¯®å­æ—¶ï¼Œç»¼åˆè‹¹æœçš„ç‰¹å¾å’Œç¯®å­çš„ç‰¹å¾ï¼Œä½œä¸ºå‚æ•°è®¡ç®—å‡ºå“ˆå¸Œå€¼ï¼Œè¿™æ ·å°±å¾—åˆ°äº†ä¸€ä¸ªå“ˆå¸Œå€¼åˆ—è¡¨ï¼Œç„¶åä»ä¸­é€‰æ‹©å“ˆå¸Œå€¼æœ€å¤§ï¼ˆæˆ–æœ€å°ï¼‰çš„ç¯®å­ä½œä¸ºæœ€ç»ˆç»“æœã€‚

![img](https://img.prochase.top/bkimg/2024/08/251b43190dd7ea1483df714de9ddfd74.png)

ä¹‹æ‰€ä»¥ç»¼åˆè‹¹æœçš„ç‰¹å¾å’Œç¯®å­çš„ç‰¹å¾ï¼Œæ˜¯ä¸ºäº†ä¿è¯ä¸ä¼šä¸ºæ‰€æœ‰é”®ç”Ÿæˆç›¸åŒçš„åºåˆ—ã€‚

è·¯ç”±æ–¹æ³•å®ç°ä»£ç ï¼š

```java
public Node route(String key) {
    if (nodeList.isEmpty()) {
        return null;
    }

    Node result = null;
    long maxHash = Long.MIN_VALUE;
    for (Node node : nodeList) {
        // è®¡ç®—å“ˆå¸Œå€¼æ—¶éœ€è¦ç»“åˆ key å’Œ node
        long hash = hashfunction.hash(key + node.key());
        if (hash > maxHash) {
            maxHash = hash;
            result = node;
        }
    }
    return result;
}
```

ç›¸è¾ƒäºä¸€è‡´æ€§å“ˆå¸Œç®—æ³•ï¼Œé›†åˆç‚¹å“ˆå¸Œä¸éœ€è¦ç»´æŠ¤å“ˆå¸Œç¯ï¼Œæ•´ä½“å®ç°æ›´ä¸ºç®€æ´ã€‚

## é›†åˆç‚¹å“ˆå¸Œçš„ä¼˜ç‚¹

é›†åˆç‚¹å“ˆå¸Œæœ€æ˜¾è‘—çš„ä¼˜ç‚¹æ˜¯æ”¯æŒ**èŠ‚ç‚¹åŠ æƒæ’åº**ã€‚æŸäº›èŠ‚ç‚¹å®¹é‡æ›´å¤§ï¼Œèƒ½å¤Ÿå­˜å‚¨æ›´å¤šçš„æ•°æ®ï¼Œå°±å¯ä»¥åˆ†é…æ›´å¤§çš„æƒå€¼ã€‚æ­¤æ—¶éœ€è¦è°ƒæ•´è®¡ç®—å…¬å¼ï¼Œä¸èƒ½å•çº¯å°†æƒå€¼ä¹˜ä»¥å“ˆå¸Œå€¼ã€‚
$$
- \frac{W_{i}}{ln\;s_{i}}
$$
å…¶ä¸­ï¼Œ$s_{i}$ ä»£è¡¨èŠ‚ç‚¹å¯¹åº”å“ˆå¸Œå€¼ä¸å“ˆå¸Œç©ºé—´ä¸Šé™çš„æ¯”å€¼ï¼Œ$s_{i} = \frac{h_{i} + 1}{Max_H}$ï¼Œå–å€¼èŒƒå›´ä¸º (0, 1]ã€‚$ln$ ä»£è¡¨è‡ªç„¶å¯¹æ•° $log_e$ã€‚

åŠ æƒç‰ˆæœ¬çš„è·¯ç”±æ–¹æ³•ï¼š

```java
public WeightedNode route(String key) {
    if (nodeList.isEmpty()) {
        return null;
    }

    WeightedNode result = null;
    double maxHash = 0;
    for (WeightedNode node : nodeList) {
        double hash = weightedScore(key, node);
        if (hash > maxHash) {
            maxHash = hash;
            result = node;
        }
    }
    return result;
}

/**
 * è®¡ç®—èŠ‚ç‚¹çš„åŠ æƒåˆ†æ•°ã€‚
 * -1 / log( hash between (0,1] ) * weight
 */
private double weightedScore(String key, WeightedNode node) {
    // unitInterval è¿”å› (0, 1] çš„æµ®ç‚¹æ•°
    double score = hashfunction.unitInterval(key + node.key());
    return -1.0 / Math.log(score) * node.getWeight();
}
```

å¯¹äºèŠ‚ç‚¹æƒé‡æ˜¯å¦å½±å“åˆ†é…ï¼Œå¯ä»¥é€šè¿‡å•å…ƒæµ‹è¯•éªŒè¯ã€‚

```java
@Test
void Route_with_different_weight() {
    // given
    IpNode[] nodes = new IpNode[3];
    for (int i = 0; i < nodes.length; i++) {
        nodes[i] = new IpNode("127.0.0." + i, i + 1);
    }
    RendezvousHashRouter<IpNode> router = new RendezvousHashRouter<>(nodes);
    // when
    int[] counts = new int[nodes.length];
    for (int i = 0; i < 100_000; i++) {
        IpNode node = router.route(getNextSequence());
        var key = node.key();
        counts[key.charAt(key.length() - 1) - '0']++;
    }
    // then
    var sum = Arrays.stream(counts).sum();
    assertThat((double) counts[0] / sum).isCloseTo(1.0 / 6, withinPercentage(1));
    assertThat((double) counts[1] / sum).isCloseTo(2.0 / 6, withinPercentage(1));
    assertThat((double) counts[2] / sum).isCloseTo(3.0 / 6, withinPercentage(1));
}
```

é›†åˆç‚¹å“ˆå¸Œçš„å¦ä¸€ä¸ªä¼˜ç‚¹æ˜¯**å†…å­˜å ç”¨ä½**ï¼Œå› ä¸ºä¸éœ€è¦é¢å¤–çš„ä¿¡æ¯ï¼Œåªè¦èŠ‚ç‚¹é›†åˆã€‚

æ­¤å¤–ï¼Œåˆ†å¸ƒå¼ç¯å¢ƒä¸‹ï¼Œé›†åˆç‚¹å“ˆå¸Œåªéœ€è¦ä¸åŒèŠ‚ç‚¹åŒæ­¥é›†åˆä¿¡æ¯å³å¯ã€‚é™¤äº†é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—ä¼ é€’èŠ‚ç‚¹å˜æ›´ä¿¡æ¯çš„æ–¹æ¡ˆï¼Œè¿˜å¯ä»¥å‚ç…§ Redis Cluster é‡‡ç”¨ Gossip åè®®å®ç°å»ä¸­å¿ƒåŒ–è®¾è®¡ã€‚

## é›†åˆç‚¹å“ˆå¸Œçš„ç¼ºç‚¹

æŒ‘é€‰èŠ‚ç‚¹æ—¶éœ€è¦ä¸ºæ¯ä¸ªèŠ‚ç‚¹è®¡ç®—å“ˆå¸Œå€¼ï¼Œç„¶åé€‰æ‹©å“ˆå¸Œå€¼æœ€å¤§çš„èŠ‚ç‚¹ï¼Œæ—¶é—´æ•ˆç‡ä¸º O(n)ï¼Œåœ¨èŠ‚ç‚¹æ•°é‡è¾ƒå¤šæ—¶æ€§èƒ½å·®ã€‚

æ¯æ¬¡è·¯ç”±éƒ½éœ€è¦ä¸ºæ¯ä¸ªèŠ‚ç‚¹è®¡ç®—ä¸€éå“ˆå¸Œå€¼ï¼Œéœ€è¦æ¶ˆè€—æ›´å¤š CPU èµ„æºã€‚

é›†åˆç‚¹å“ˆå¸Œç®—æ³•åœ¨**å¢åŠ èŠ‚ç‚¹æ—¶å¯èƒ½å‡ºç°é—®é¢˜**ã€‚æ–°å¢ä¸€ä¸ªç¯®å­ï¼Œä¼šæ”¹å˜æŸäº›è‹¹æœçš„ç¯®å­åºåˆ—çš„ç¬¬ä¸€åï¼Œéœ€è¦å°†è¿™äº›è‹¹æœè¿ç§»åˆ°æ–°çš„ç¯®å­ã€‚

è¿ç§»æ–¹æ¡ˆåŒ…æ‹¬ä¸»åŠ¨è¿ç§»å’Œè¢«åŠ¨è¿ç§»ã€‚ä¸»åŠ¨è¿ç§»è¦ä¹ˆéå†æ‰€æœ‰æ•°æ®ï¼Œè¦ä¹ˆè®°å½•æ•°æ®å½’å±ä¿¡æ¯ï¼Œæˆæœ¬éƒ½å¤ªé«˜ï¼Œé€šå¸¸ä¸ä¼šè€ƒè™‘ã€‚è¢«åŠ¨è¿ç§»å…·å¤‡å¯è¡Œæ€§ï¼Œåœ¨è®¿é—®æ•°æ®æ—¶å‘ç°æ•°æ®ä¸å­˜åœ¨ï¼Œå°±è‡ªåŠ¨å®Œæˆè¿ç§»ã€‚è¿™ä»£è¡¨é›†ç¾¤çš„ã€Œè‡ªæ„ˆæ€§ã€ã€‚

å› æ­¤ï¼Œé›†åˆç‚¹å“ˆå¸Œçš„å¯æ‰©å±•æ€§æ˜¯æœ‰é™åˆ¶çš„ã€‚åªèƒ½åœ¨å¯ä»¥â€œè‡ªæ„ˆâ€çš„åœºæ™¯ä½¿ç”¨ã€‚æ¯”å¦‚åˆ†å¸ƒå¼ç¼“å­˜ï¼Œæ–°å¢èŠ‚ç‚¹åï¼ŒæŸäº› key çš„ç¬¬ä¸€é€‰æ‹©ä¼šå˜ä¸ºæ–°å¢èŠ‚ç‚¹ï¼Œæ­¤æ—¶æ•°æ®è¿˜æœªè¿ç§»åˆ°æ–°èŠ‚ç‚¹ï¼Œåˆæ¬¡è®¿é—®ä¼š missï¼Œä»æ•°æ®åº“è¯»å–æ•°æ®åæ‰æ¢å¤æ­£å¸¸ã€‚

## ä¸ä¸€è‡´æ€§å“ˆå¸Œå¯¹æ¯”

é›†åˆç‚¹å“ˆå¸Œä¸ä¸€è‡´æ€§å“ˆå¸Œç›¸æ¯”ï¼Œé™¤äº†å®ç°ç®€å•ã€å†…å­˜å¼€é”€å°ã€æ”¯æŒåŠ æƒå¤–ï¼Œé›†åˆç‚¹å“ˆå¸Œæ•°æ®æ›´åŠ å‡åŒ€ã€‚

é€šè¿‡ç»Ÿè®¡ä¸åŒé”®æ•°é‡ä¸‹å„ä¸ªèŠ‚ç‚¹æ‰¿è½½é”®æ•°é‡ï¼Œè®¡ç®—å‡ºå˜å¼‚ç³»æ•°ï¼Œå¾—åˆ°èŠ‚ç‚¹æ‰¿è½½çš„æ³¢åŠ¨ç¨‹åº¦ã€‚å˜å¼‚ç³»æ•°æ˜¯æ ‡å‡†å·®ä¸å¹³å‡å€¼çš„æ¯”å€¼ï¼Œå˜å¼‚ç³»æ•°è¶Šå¤§ï¼Œæ•°æ®çš„å˜å¼‚ç¨‹åº¦è¶Šå¤§ï¼Œä¹Ÿå°±æ˜¯è¶Šä¸å‡åŒ€ã€‚

3 ä¸ªç‰©ç†èŠ‚ç‚¹ï¼Œé”®çš„æ•°é‡åˆ†åˆ«ä¸º 10000ã€100000ã€1000000ã€5000000ï¼Œè®¡ç®—ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•å’Œé›†åˆç‚¹å“ˆå¸Œç®—æ³•çš„å˜å¼‚ç³»æ•°ã€‚è¿™é‡Œä¸€è‡´æ€§å“ˆå¸Œç®—æ³•ä½¿ç”¨ 1000 ä¸ªè™šæ‹ŸèŠ‚ç‚¹ï¼Œæœ€å¤§ç¨‹åº¦å±è”½è¯¯å·®ã€‚

![ä¸€è‡´æ€§å“ˆå¸Œ vs é›†åˆç‚¹å“ˆå¸Œ](https://img.prochase.top/bkimg/2024/08/633de067fd89ca7cfa308edf97e8eea5.png)

ä»å›¾è¡¨ä¸­å¯ä»¥çœ‹å‡ºï¼Œé›†åˆç‚¹å“ˆå¸Œæ˜æ˜¾æ¯”ä¸€è‡´æ€§å“ˆå¸Œæ›´å‡åŒ€ã€‚

åŸå§‹æ•°æ®ï¼šé”®æ•°é‡ã€å„èŠ‚ç‚¹æ•°é‡é‡ã€å„èŠ‚ç‚¹æ•°æ®æ¯”ä¾‹ã€å˜å¼‚ç³»æ•°ã€‚

ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•åŸå§‹æ•°æ®ï¼š

```
10000, [3160, 3526, 3314], [0.316, 0.3526, 0.3314], 0.04501288704360118
100000, [32152, 34877, 32971], [0.32152, 0.34877, 0.32971], 0.034247951763572655
1000000, [321863, 347541, 330596], [0.321863, 0.347541, 0.330596], 0.031980587830745075
5000000, [1606436, 1738237, 1655327], [0.3212872, 0.3476474, 0.3310654], 0.03264101811034698
```

é›†åˆç‚¹å“ˆå¸ŒåŸå§‹æ•°æ®ï¼š

```
10000, [3264, 3341, 3395], [0.3264, 0.3341, 0.3395], 0.01612637591029057
100000, [33202, 33202, 33596], [0.33202, 0.33202, 0.33596], 0.005572001435749993
1000000, [333117, 333598, 333285], [0.333117, 0.333598, 0.333285], 5.979581925185071E-4
5000000, [1667166, 1666841, 1665993], [0.3334332, 0.3333682, 0.3331986], 2.9669229851817864E-4
```

## é€‚ç”¨åœºæ™¯

é›†åˆç‚¹å“ˆå¸Œç®—æ³•é€‚åˆ**ä¸­å°å‹åˆ†å¸ƒå¼ç¼“å­˜**ï¼Œå†…å­˜å ç”¨å°‘ï¼Œå®ç°ç®€å•ï¼Œä½†ç”±äºæ°´å¹³æ‰©å±•æ—¶ä¼šå¯¼è‡´é”™è¯¯è·¯ç”±ç»“æœï¼Œæ‰€ä»¥è¦æ±‚**ç¼“å­˜èŠ‚ç‚¹å…·å¤‡ã€Œè‡ªæ„ˆæ€§ã€**ã€‚

æœ¬æ–‡ä»£ç å·²ç»ä¸Šä¼  [GitHub](https://github.com/xioshe/routing-strategy/blob/main/src/main/java/com/github/xioshe/routing/routers/RendezvousHashRouter.java)ã€‚

## å‚è€ƒæ–‡ç« 

[1] [Rendezvous Hashing Explained - Randorithms](https://randorithms.com/2020/12/26/rendezvous-hashing.html)

[2] [Rendezvous hashing - Wikipedia](https://en.wikipedia.org/wiki/Rendezvous_hashing#cite_note-:11-17)
